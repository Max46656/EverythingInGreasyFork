// ==UserScript==
// @name            ‰ΩúËÄÖËøëÊúü‰ΩúÂìÅÁÄèË¶Ω
// @name:en         Artist Recent Works Preview
// @name:ja         „Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÊúÄÊñ∞‰ΩúÂìÅ„Éó„É¨„Éì„É•„Éº
// @name:de         Vorschau der neuesten Werke von K√ºnstlern
// @name:uk         –ü–µ—Ä–µ–≥–ª—è–¥ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —Ä–æ–±—ñ—Ç —Ö—É–¥–æ–∂–Ω–∏–∫—ñ–≤
// @description     Âú® /artists ÁöÑ‰ΩúËÄÖÊ¨Ñ‰∏≠È°ØÁ§∫‰ΩúËÄÖÁöÑËøëÊúü 3 ÂÄã‰ΩúÂìÅÔºåÊñπ‰æøÂø´ÈÄüÁû≠Ëß£Ââµ‰ΩúÈ¢®Ê†º„ÄÇÊîØÊè¥Kemono/Coomer„ÄÇ
// @description:en  Displays the 3 most recent works in the /artists section for quick insight into their creative style. Supports Kemono and Coomer.
// @description:ja  /artists „ÅÆ„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÊ¨Ñ„Å´ÊúÄÊñ∞3‰ΩúÂìÅ„ÇíË°®Á§∫„Åó„ÄÅÂâµ‰Ωú„Çπ„Çø„Ç§„É´„ÇíÁ¥†Êó©„ÅèÊääÊè°„Åß„Åç„Åæ„Åô„ÄÇKemono„Å®Coomer„Å´ÂØæÂøú„ÄÇ
// @description:de  Zeigt die 3 neuesten Werke im /artists-Bereich an, um den kreativen Stil schnell zu erfassen. Unterst√ºtzt Kemono und Coomer.
// @description:uk  –í—ñ–¥–æ–±—Ä–∞–∂–∞—î 3 –æ—Å—Ç–∞–Ω–Ω—ñ —Ä–æ–±–æ—Ç–∏ –≤ —Ä–æ–∑–¥—ñ–ª—ñ /artists –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è –∑ —Ç–≤–æ—Ä—á–∏–º —Å—Ç–∏–ª–µ–º. –ü—ñ–¥—Ç—Ä–∏–º—É—î Kemono —ñ Coomer.

// @match        *://kemono.cr/artists*
// @match        *://*.kemono.cr/artists*
// @match        *://coomer.st/artists*
// @match        *://*.coomer.st/artists*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=kemono.cr
// @grant        GM_addStyle
// @version      1.0.0

// @author       Max
// @namespace    https://greasyfork.org/zh-TW/users/1021017-max46656
// @license MPL2.0
// ==/UserScript==

class ArtistCardEnhancer {
    constructor() {
        this.queue = [];
        this.observer = null;
        this.processedCards = new Set();
        this.init();
    }

    init() {
        this.loadArtistCards();
        this.setupMutationObserver();
        this.addStyle()
    }

    addStyle(){
        const STYLES = `
      .card-list--legacy .card-list__items {
          display: grid !important;
          grid-template-columns: repeat(auto-fill, 250px);
          gap: 16px;
          padding: 16px;
          width: 100%;
          margin: 0 auto;
          grid-auto-rows: auto;
      }

      .post-card {
          width: 100% !important;
          margin: 0 !important;
          break-inside: avoid;
          background: rgba(0, 0, 0, 0.5);
          border-radius: 8px;
          overflow: hidden;
          height: auto !important;
          transition: transform 0.2s ease;
          position: relative;
          font-size: larger;
          padding: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .post-card:hover {
          transform: translateY(-2px);
      }

      .post-card__image-container {
          position: relative;
          width: 100%;
          height: auto !important;
      }

      .post-card__image {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
          border-radius: 2%;
      }

      .post-card--preview.mini-preview {
          font-size: smaller;
          width: 33%;
          margin: 5px;
          padding: 5px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .post-card--preview .fancy-link--kemono {
          display: flex;
          flex-direction: column;
          align-items: center;
          text-decoration: none;
          position: relative;
      }

      .post-card__footer {
          position: absolute;
          bottom: 0;
          width: 100%;
          background: rgba(0,0,0,0.3);
          text-align: center;
          padding: 5px 0;
      }

      .post-card__footer > div {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 5px;
      }

      .post-card__footer .attachment-count {
          width: 20px;
          display: flex;
          align-items: center;
      }

      .post-card__footer .attachment-count svg {
          width: 100%;
          height: 100%;
          fill: white;
      }

      .post-card__footer .title {
          font-size: 0.7em;
          color: white;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
      }

      .header-container {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-bottom: 10px;
      }

      .header-container .fancy-link {
          display: inline-flex;
          align-items: center;
          text-decoration: none;
          margin-bottom: 8px;
      }

      .header-container .fancy-image__image {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          object-fit: cover;
      }

      .post-card__header {
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
      }

      .post-card__header .user-card__service {
          font-size: 0.9em;
          color: #888;
      }

      .post-card__header .user-card__name {
          font-size: 1.1em;
          font-weight: bold;
      }

      .post-card__header .user-card__count {
          font-size: 0.8em;
          color: #666;
      }

      .artist-previews-container {
          flex-direction: row;
          justify-content: space-between;
          margin-top: 10px;
      }
  `;

        GM_addStyle(STYLES);
    }

    loadArtistCards() {
        this.artistCards = Array.from(document.querySelectorAll('a.user-card:not([data-processed="true"])'));

        const invalidCards = this.artistCards.filter(card => !card.href);

        if (invalidCards.length > 0) {
            console.warn(`${invalidCards.length}È†Ö‰ΩúËÄÖÂç°Â∞öÊú™ËºâÂÖ•ÂÆåÊàêÔºåÈáçË©¶‰∏≠`);
            setTimeout(() => this.loadArtistCards(), 1000);
            return;
        }

        this.queue = Array.from(this.artistCards);
        if (this.queue.length > 0) {
            this.processQueue();
        } else if (this.processedCards.size >= 50) {
            if (this.observer) {
                this.observer.disconnect();
                console.log('Â∑≤ËôïÁêÜ50Âºµ‰ΩúËÄÖÂç°');
            }
            document.title = "[üàµpageDone!]";
        }
    }

    setupMutationObserver() {
        const observer = new MutationObserver((mutations) => {
            const hasNewCards = mutations.some(mutation =>
                                               Array.from(mutation.addedNodes).some(node =>
                                                                                    node.nodeType === Node.ELEMENT_NODE &&
                                                                                    node.matches('a.user-card:not([data-processed="true"])')
                                                                                   )
                                              );
            if (hasNewCards) {
                this.loadArtistCards();
            }
        });
        observer.observe(document.body, { childList: true, subtree: true });
        this.observer = observer;
    }

    async fetchUpdateArticles(url) {
        const articles = [];
        const seenPostIds = new Set();
        const isKemono = url.includes('kemono');
        let cleanUrl = url.replace(/^.*(?=\/[^\/]+\/user\/[^\/]+)/, "");
        let creatorPostsApi, creatorInfoApi;
        if (isKemono) {
            creatorPostsApi = 'https://kemono.cr/api/v1' + cleanUrl + '/posts';
            creatorInfoApi = 'https://kemono.cr/api/v1' + cleanUrl + '/profile';
            console.log(`Fetching posts from: ${creatorPostsApi}`);
        } else {
            creatorPostsApi = 'https://coomer.st/api/v1' + cleanUrl + '/posts';
            creatorInfoApi = 'https://coomer.st/api/v1' + cleanUrl + '/profile';
        }
        try {
            const postsResponse = await fetch(creatorPostsApi, {
                headers: {
                    'Accept': 'text/css'
                }
            });
            if (!postsResponse.ok) {
                console.warn(`API Ë´ãÊ±ÇÂ§±ÊïóÔºåÁãÄÊÖãÁ¢ºÔºö${postsResponse.status}ÔºåÈáçË©¶‰∏≠...`);
                await this.delay(2000);
                return this.fetchUpdateArticles(url);
            }
            const posts = await postsResponse.json();
            console.log(`API ËøîÂõû ${posts.length} ÂÄã‰ΩúÂìÅ`);

            if (posts.length === 0) {
                console.log('ÁÑ°ÂèØÁî®‰ΩúÂìÅ');
                return articles;
            }

            let newerPosts = posts.slice(0, 3);
            console.log(`ÈÅ∏Âèñ ${newerPosts.length} ÂÄã‰ΩúÂìÅ`);

            const infoResponse = await fetch(creatorInfoApi, {
                headers: {
                    'Accept': 'text/css'
                }
            });
            const info = await infoResponse.json();
            const userName = info.name;

            for (let post of newerPosts) {
                if (seenPostIds.has(post.id)) continue;
                seenPostIds.add(post.id);
                const articleId = post.id;
                const service = post.service;
                const user = post.user;
                const title = post.title || 'ÁÑ°Ê®ôÈ°å';
                const filePath = post.file ? post.file.path : '';
                const timestamp = post.published || post.added;
                const attachmentsCount = post.attachments ? post.attachments.length : 0;

                const href = `/${service}/user/${user}/post/${articleId}`;
                const imgSrc = filePath

                const articleHtml = `
                <article class="post-card post-card--preview mini-preview" data-id="${articleId}" data-service="${service}" data-user="${user}">
                  <a class="fancy-link fancy-link--kemono" href="${href}">
                      <div class="post-card__image-container"><img class="post-card__image" src="${imgSrc}" loading="lazy"></div>
                      <footer class="post-card__footer">
                          <div>
                              <div class="attachment-count">${attachmentsCount}
                                  <svg viewBox="0 0 10 10">
                                      <path d="M8,3 C8.55228475,3 9,3.44771525 9,4 L9,9 C9,9.55228475 8.55228475,10 8,10 L3,10
                                          C2.44771525,10 2,9.55228475 2,9 L6,9 C7.1045695,9 8,8.1045695 8,7 L8,3 Z M1,1 L6,1
                                          C6.55228475,1 7,1.44771525 7,2 L7,7 C7,7.55228475 6,8 6,8 L1,8 C0.44771525,8
                                          0,7.55228475 0,7 L0,2 C0,1.44771525 0.44771525,1 1,1 Z" transform="">
                                      </path>
                                  </svg>
                              </div>
                              <div class="title">${title}</div>
                          </div>
                      </footer>
                  </a>
                  <time class="timestamp" datetime="${timestamp}" style="display: none;"></time>
              </article>`;
                const parser = new DOMParser();
                const doc = parser.parseFromString(articleHtml, 'text/html');
                const articleElement = doc.body.firstChild;
                articles.push(articleElement);
            }
            console.log(`ÁîüÊàê‰∫Ü ${articles.length} ÂÄã‰ΩúÂìÅÂÖÉÁ¥†`);
        } catch (error) {
            console.error(`Áç≤Âèñ‰ΩúÂìÅ ${url} Â§±Êïó:`, error);
        }
        return articles;
    }

    async addArticlesToCard(artistCard, articles) {
        if (articles.length === 0) {
            console.log(`ÁÑ°‰ΩúÂìÅÂèØÊ∑ªÂä†Âà∞Âç°Áâá ${artistCard.getAttribute('data-id')}`);
            artistCard.setAttribute('data-processed', 'true');
            this.processedCards.add(artistCard.getAttribute('data-id'));
            return;
        }

        const userId = artistCard.getAttribute('data-id');
        const service = artistCard.getAttribute('data-service');
        const userName = artistCard.querySelector('.user-card__name')?.textContent.trim() || 'Unknown';
        const userIcon = artistCard.querySelector('.fancy-image__image')?.src || 'https://via.placeholder.com/50';
        const userFavorites = artistCard.querySelector('.user-card__count')?.textContent.trim() || '0 favorites';
        const userHref = artistCard.getAttribute('href');
        const originalStyle = artistCard.getAttribute('style') || '';
        const originalClasses = artistCard.className;

        // ÂâµÂª∫Êñ∞ÁöÑ‰ΩúËÄÖËàá‰ΩúÂìÅÂç°
        const newCard = document.createElement('a');
        newCard.className = `${originalClasses} post-card post-card--preview`;
        newCard.setAttribute('data-id', userId);
        newCard.setAttribute('data-service', service);
        newCard.setAttribute('data-processed', 'true');
        newCard.setAttribute('data-discover', artistCard.getAttribute('data-discover') || 'true');
        newCard.setAttribute('fix', artistCard.getAttribute('fix') || 'true');
        newCard.setAttribute('style', originalStyle);

        // Ê∑ªÂä†‰ΩúËÄÖË≥áË®ä
        const headerContainer = document.createElement('div');
        headerContainer.className = 'header-container';

        // Ê∑ªÂä†È†≠ÂÉè
        const userProfileLink = document.createElement('a');
        userProfileLink.className = 'fancy-link';
        userProfileLink.setAttribute('data-id', userId);
        userProfileLink.setAttribute('data-service', service);
        userProfileLink.setAttribute('href', userHref);
        userProfileLink.innerHTML = `
            <span class="fancy-image">
                <picture class="fancy-image__picture">
                    <img class="fancy-image__image" src="${userIcon}" loading="lazy">
                </picture>
            </span>
        `;
        headerContainer.appendChild(userProfileLink);

        const header = document.createElement('header');
        header.className = 'post-card__header';
        header.innerHTML = `
            <div>
                <span class="user-card__service">${service}</span>
                <span class="user-card__name">${userName}</span>
                <span class="user-card__count">${userFavorites}</span>
            </div>
        `;
        headerContainer.appendChild(header);
        newCard.appendChild(headerContainer);

        // Ê∑ªÂä†‰ΩúÂìÅÈ†êË¶ΩÂÆπÂô®
        const previewsContainer = document.createElement('div');
        previewsContainer.className = 'artist-previews-container';
        articles.forEach(article => {
            previewsContainer.appendChild(article);
        });
        newCard.appendChild(previewsContainer);

        // ÊõøÊèõÂéü‰ΩúËÄÖÂç°
        artistCard.parentNode.replaceChild(newCard, artistCard);
        this.processedCards.add(userId);
        console.log(`Â∑≤ÁÇ∫Âç°Áâá ${userId} Ê∑ªÂä† ${articles.length} ÂÄã‰ΩúÂìÅ`);
    }

    async processQueue() {
        while (this.queue.length > 0) {
            const card = this.queue.shift();
            try {
                if (!card.href) {
                    throw new Error("Card href ÁÇ∫null");
                }

                const articles = await this.fetchUpdateArticles(card.href);
                await this.addArticlesToCard(card, articles);
                document.title = "[üà±favoritesReading]";
            } catch (e) {
                console.error(`${card}ÈåØË™§Ôºö`, e);
                document.title = "[üà≤waitForApi]";
                if (card) this.queue.push(card);
                await this.delay(1000);
            }
        }
        if (this.processedCards.size >= 50) {
            if (this.observer) {
                this.observer.disconnect();
                console.log('Â∑≤ËôïÁêÜ50Âºµ‰ΩúËÄÖÂç°ÔºåÂÅúÊ≠¢ËßÄÂØü');
            }
            document.title = "[üàµpageDone!]";
        }
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

class PageIndicatorObserver {
    constructor(selector, checkInterval = 1000) {
        this.selector = selector;
        this.checkInterval = checkInterval;
        this.pageIndicator = null;
        this.retryInterval = null;
        this.observer = null;
        this.init();
    }

    init() {
        this.retryInterval = setInterval(() => {
            this.pageIndicator = document.querySelector(this.selector);
            if (this.pageIndicator) {
                clearInterval(this.retryInterval);
                this.setupObserver();
            } else {
                console.log(`${this.selector} È†ÅÊï∏È°ØÁ§∫Âô®Êú™Áç≤Âèñ`);
            }
        }, this.checkInterval);
    }

    setupObserver() {
        if (!this.pageIndicator) return;

        console.log("pageIndicator:", this.pageIndicator);

        this.observer = new MutationObserver((mutationsList) => {
            mutationsList.forEach((mutation) => {
                //console.log("ÁøªÈ†ÅÂÅµÊ∏¨:Ôºå");
                this.stop();
                window.location.reload();
            });
        });

        const observerOptions = {
          subtree: true,
          characterData: true,
        };

        this.observer.observe(this.pageIndicator, observerOptions);
    }

    stop() {
        if (this.retryInterval) {
            clearInterval(this.retryInterval);
            this.retryInterval = null;
        }
        if (this.observer) {
            this.observer.disconnect();
            this.observer = null;
        }
        //console.log("ÂÅúÊ≠¢ËßÄÂØü");
    }
}

new ArtistCardEnhancer();

new PageIndicatorObserver("#paginator-top", 500);
